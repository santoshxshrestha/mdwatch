<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>{{ title }} - mdwatch</title>
    <style>
      {{ style | safe }}
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
      <i class="fa-solid fa-moon"></i>
    </button>
    <article id="content">{{content | safe}}</article>

    <script>
      function setThemeIcon(theme) {
        const button = document.querySelector(".theme-toggle");
        if (!button) return;
        button.innerHTML =
          theme === "light"
            ? '<i class="fa-regular fa-sun"></i>'
            : '<i class="fa-solid fa-moon"></i>';
      }

      function toggleTheme() {
        const html = document.documentElement;
        const isLight = html.getAttribute("data-theme") === "light";

        if (isLight) {
          html.removeAttribute("data-theme");
          localStorage.setItem("theme", "dark");
          setThemeIcon("dark");
        } else {
          html.setAttribute("data-theme", "light");
          localStorage.setItem("theme", "light");
          setThemeIcon("light");
        }
      }

      // Load saved theme on page load
      document.addEventListener("DOMContentLoaded", function () {
        const savedTheme = localStorage.getItem("theme");
        const html = document.documentElement;

        if (savedTheme === "light") {
          html.setAttribute("data-theme", "light");
          setThemeIcon("light");
        } else {
          setThemeIcon("dark");
        }
      });

      // let lastSeen = Number(sessionStorage.getItem("lastSeen") || 0);
      //
      // setInterval(() => {
      //   fetch("/api/check-update")
      //     .then((res) => res.json())
      //     .then((data) => {
      //       if (data.last_modified > lastSeen) {
      //         sessionStorage.setItem("lastSeen", data.last_modified);
      //         location.reload();
      //       }
      //     });
      // }, 1000);

      // Add smooth scrolling for anchor links
      document.addEventListener("click", function (e) {
        if (
          e.target.tagName === "A" &&
          e.target.getAttribute("href").startsWith("#")
        ) {
          e.preventDefault();
          const target = document.querySelector(e.target.getAttribute("href"));
          if (target) {
            target.scrollIntoView({ behavior: "smooth" });
          }
        }
      });

      const proto = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${proto}://${location.host}/ws`);

      ws.onopen = () => {
        console.log("connected");
        // ws.send("Hello from client!");
      };

      // ws.onmessage = (event) => {
      //   console.log("server: " + event.data);
      //   if (event.data === "reload") {
      //     console.log("log: changes detected, reloading...");
      //     location.reload();
      //   }
      // };
      ws.onmessage = (event) => {
        console.log("server: here is your new data");
        content.innerHTML = event.data;
      };

      ws.onclose = () => console.log("closed");
      ws.onerror = (e) => console.log("error");
    </script>
  </body>
</html>
